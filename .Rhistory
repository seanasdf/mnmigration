library(purrr)
library(srvyr)
######################################
######### Migration to MN   ##########
######### From Other States ##########
######################################
if (file.exists("inmigration.rda")) {
load("inmigration.rda")
} else {
source("clean.R")
}
#get count of m
inmigration_by_group <- inmigration %>%
mutate(moved_states = ifelse(!(MIGPLAC1 %in% c(0,27)) & MIGPLAC1<100, 1, 0)) %>%
as_survey(weights = PERWT) %>%
group_by(geogroup, agegroup) %>%
summarise(moved_in = survey_total(moved_states))
#Verify that the srvyr match up with the R survey package
library(survey)
inmigration_by_group_2 <- inmigration %>%
mutate(moved_states = ifelse(!(MIGPLAC1 %in% c(0,27)) & MIGPLAC1<100, 1, 0))
inmigration_by_group_2 <- svydesign(ids = ~1,
data= inmigration_by_group_2,
weights = inmigration$PERWT)
inmigration_by_group_2 <- svyby(~moved_states, ~agegroup+geogroup, inmigration_by_group_2, svytotal)
inmigration_by_group
inmigration_by_group_2
?read_excel
library(readxl)
?read_excel
#read in crosswalk for years and MIGPUMAs to Geographic Groupings
migpumacrosswalk <- read_excel("./crosswalk/migpumacrosswalk.xlsx",
sheet = "MigPUMAtoGeogroup")
migpumacrosswalk
outmigration <- read_csv("usa_00009.csv.gz") %>%
filter(STATEFIP != 27)
outmigration
#read in crosswalk for years and MIGPUMAs to Geographic Groupings
migpumacrosswalk <- read_excel("./crosswalk/migpumacrosswalk.xlsx",
sheet = "MigPUMAtoGeogroup")
outmigration <- read_csv("usa_00012.csv.gz") %>%
filter(STATEFIP != 27)
migpumacrosswal
migpumacrosswalk
outmigration <- read_csv("usa_00012.csv.gz")
head(outmigration)
View(outmigration)
table(outmigration$STATEFIP)
#read in crosswalk for years and MIGPUMAs to Geographic Groupings
migpumacrosswalk <- read_excel("./crosswalk/migpumacrosswalk.xlsx",
sheet = "MigPUMAtoGeogroup")
outmigration <- read_csv("usa_00012.csv.gz") %>%
filter(STATEFIP != 27)
nrow(outmigration)
outmigration <- read_csv("usa_00012.csv.gz") %>%
filter(STATEFIP != 27) %>%
left_join(migpumacrosswalk, by=c("MIGPUMA1"="PUMA", "MULTYEAR"="Year"))
nrow(outmigration)
View(migpumacrosswalk)
View(outmigration)
outmigration <- read_csv("usa_00012.csv.gz") %>%
filter(STATEFIP != 27) %>%
left_join(migpumacrosswalk, by=c("MIGPUMA1"="PUMA", "MULTYEAR"="Year"))
outmigration <- read_csv("usa_00012.csv.gz") %>%
filter(STATEFIP != 27) %>%
left_join(migpumacrosswalk, by=c("MIGPUMA1"="MIGPUMA", "MULTYEAR"="Year"))
nrow(outmigration)
sum(is.na(inmigration$geogroup))
sum(is.na(outmigration$geogroup))
#read in crosswalk for years and MIGPUMAs to Geographic Groupings
migpumacrosswalk <- read_excel("./crosswalk/migpumacrosswalk.xlsx",
sheet = "MigPUMAtoGeogroup")
outmigration <- read_csv("usa_00012.csv.gz") %>%
filter(STATEFIP != 27) %>%
left_join(migpumacrosswalk, by=c("MIGPUMA1"="MIGPUMA", "MULTYEAR"="Year"))
sum(is.na(outmigration$geogroup))
nrow(outmigration)
library(tidyr)
library(readxl)
######################################
######### Migration to MN   ##########
######### From Other States ##########
######################################
#read in crosswalk for years and PUMAs to Geographic Groupings
pumacrosswalk <- read_excel("./crosswalk/crosswalk_puma_to_mncounty.xlsx")
names(pumacrosswalk)[3] <- "geogroup"
#read in extract from IPUMS and join with crosswalk to geographic groupings
inmigration <- read_csv("usa_00011.csv.gz") %>%
left_join(pumacrosswalk, by=c("PUMA"="PUMA", "MULTYEAR"="Year")) %>%
mutate(agegroup = case_when(
AGE<17 ~ "16 and Younger",
AGE>=17 & AGE<24 ~ "17 to 23",
AGE>=24 & AGE<31 ~ "24 to 30",
AGE>=31 ~ "31 and Over"
))
save(inmigration, file="inmigration.rda")
######################################
######### Migration from MN ##########
######### to Other States ############
######################################
#read in crosswalk for years and MIGPUMAs to Geographic Groupings
migpumacrosswalk <- read_excel("./crosswalk/migpumacrosswalk.xlsx",
sheet = "MigPUMAtoGeogroup")
outmigration <- read_csv("usa_00012.csv.gz") %>%
filter(STATEFIP != 27) %>%
left_join(migpumacrosswalk, by=c("MIGPUMA1"="MIGPUMA", "MULTYEAR"="Year")) %>%
mutate(agegroup = case_when(
AGE<17 ~ "16 and Younger",
AGE>=17 & AGE<24 ~ "17 to 23",
AGE>=24 & AGE<31 ~ "24 to 30",
AGE>=31 ~ "31 and Over"
))
save(outmigration, file="outmigration.rda")
if (file.exists("outmigration.rda")) {
load("outmigration.rda")
} else {
source("clean.R")
}
outmigration <- read_csv("usa_00009.csv.gz") %>%
filter(STATEFIP != 27) %>%
mutate(geogroup =ifelse(MIGPUMA1==1400, "Hennepin",
ifelse(MIGPUMA1==1300, "Ramsey", "All Other Counties")),
agegroup = ifelse(AGE<17, "16 and Younger",
ifelse(AGE>=17 & AGE<24, "17 to 23",
ifelse(AGE>=24 & AGE<31, "24 to 30", "31 and Over")
)
)) %>%
as_survey_design(weights=PERWT)  %>%
group_by(geogroup, agegroup) %>%
summarise(moved_out = survey_total())
outmigration <- outmigration %>%
as_survey_design(weights=PERWT)  %>%
group_by(geogroup, agegroup) %>%
summarise(moved_out = survey_total())
outmigration
?svyby
if (file.exists("outmigration.rda")) {
load("outmigration.rda")
} else {
source("clean.R")
}
outmigration_by_group <- outmigration
as_survey_design(weights=PERWT)  %>%
group_by(geogroup, agegroup) %>%
summarise(moved_out = survey_total())
#Verify that the srvyr match up with the R survey package
outmigration_by_group_2 <- outmigration %>% mutate(one = 1)
outmigration_by_group_2 <- svydesign(ids = ~1,
data= alternate_outmigration,
weights = alternate_outmigration$PERWT)
outmigration_by_group_2 <- svyby(~one, ~geogroup+agegroup, alternate_out_survey, svytotal)
if (file.exists("outmigration.rda")) {
load("outmigration.rda")
} else {
source("clean.R")
}
outmigration_by_group <- outmigration %>%
as_survey_design(weights=PERWT)  %>%
group_by(geogroup, agegroup) %>%
summarise(moved_out = survey_total())
#Verify that the srvyr match up with the R survey package
outmigration_by_group_2 <- outmigration %>% mutate(one = 1)
outmigration_by_group_2 <- svydesign(ids = ~1,
data= alternate_outmigration,
weights = alternate_outmigration$PERWT)
outmigration_by_group_2 <- svyby(~one, ~geogroup+agegroup, alternate_out_survey, svytotal)
outmigration_by_group
outmigration_by_group_2 <- outmigration %>% mutate(one = 1)
outmigration_by_group_2 <- svydesign(ids = ~1,
data= outmigration_by_group_2,
weights = alternate_outmigration$PERWT)
outmigration_by_group_2 <- svyby(~one, ~geogroup+agegroup, alternate_out_survey, svytotal)
outmigration_by_group_2 <- svydesign(ids = ~1,
data= outmigration_by_group_2,
weights = outmigration_by_group_2$PERWT)
outmigration_by_group_2 <- svyby(~one, ~geogroup+agegroup, alternate_out_survey, svytotal)
outmigration_by_group_2 <- svyby(~one, ~geogroup+agegroup, outmigration_by_group_2, svytotal)
outmigration_by_group
outmigration_by_group_2
#Verify that the srvyr match up with the R survey package
outmigration_by_group_2 <- outmigration %>% mutate(one = 1)
outmigration_by_group_2 <- svydesign(ids = ~1,
data= outmigration_by_group_2,
weights = outmigration_by_group_2$PERWT)
outmigration_by_group_2 <- svyby(~one, ~agegroup+geogroup, outmigration_by_group_2, svytotal)
outmigration_by_group
outmigration_by_group_2
netmig <- left_join(inmigration_by_group, outmigration_by_group) %>%
mutate(net_migration = moved_in-moved_out )
write.csv(netmig, "netmigration.csv")
netmig <- left_join(inmigration_by_group, outmigration_by_group) %>%
mutate(net_migration = moved_in-moved_out )
library(dplyr)
library(readr)
library(purrr)
library(srvyr)
######################################
######### Migration to MN   ##########
######### From Other States ##########
######################################
if (file.exists("inmigration.rda")) {
load("inmigration.rda")
} else {
source("clean.R")
}
#get count of m
inmigration_by_group <- inmigration %>%
mutate(moved_states = ifelse(!(MIGPLAC1 %in% c(0,27)) & MIGPLAC1<100, 1, 0)) %>%
as_survey(weights = PERWT) %>%
group_by(geogroup, agegroup) %>%
summarise(moved_in = survey_total(moved_states))
# #Verify that the srvyr match up with the R survey package
# library(survey)
# inmigration_by_group_2 <- inmigration %>%
#   mutate(moved_states = ifelse(!(MIGPLAC1 %in% c(0,27)) & MIGPLAC1<100, 1, 0))
#
# inmigration_by_group_2 <- svydesign(ids = ~1,
#             data= inmigration_by_group_2,
#             weights = inmigration$PERWT)
#
# inmigration_by_group_2 <- svyby(~moved_states, ~geogroup+agegroup, inmigration_by_group_2, svytotal)
######################################
######### Migration from MN ##########
######################################
if (file.exists("outmigration.rda")) {
load("outmigration.rda")
} else {
source("clean.R")
}
outmigration_by_group <- outmigration %>%
as_survey_design(weights=PERWT)  %>%
group_by(geogroup, agegroup) %>%
summarise(moved_out = survey_total())
# #Verify that the srvyr match up with the R survey package
# outmigration_by_group_2 <- outmigration %>% mutate(one = 1)
#
# outmigration_by_group_2 <- svydesign(ids = ~1,
#                                   data= outmigration_by_group_2,
#                                   weights = outmigration_by_group_2$PERWT)
#
# outmigration_by_group_2 <- svyby(~one, ~agegroup+geogroup, outmigration_by_group_2, svytotal)
######################################
######### Graph Net Migration ########
######################################
netmig <- left_join(inmigration_by_group, outmigration_by_group) %>%
mutate(net_migration = moved_in-moved_out )
netmig
library(tidyverse)
library(srvyr)
######################################
######### Migration to MN   ##########
######### From Other States ##########
######################################
if (file.exists("inmigration.rda")) {
load("inmigration.rda")
} else {
source("clean.R")
}
#get count of m
inmigration_by_group <- inmigration %>%
mutate(moved_states = ifelse(!(MIGPLAC1 %in% c(0,27)) & MIGPLAC1<100, 1, 0)) %>%
as_survey(weights = PERWT) %>%
group_by(geogroup, agegroup) %>%
summarise(moved_in = survey_total(moved_states))
# #Verify that the srvyr match up with the R survey package
# library(survey)
# inmigration_by_group_2 <- inmigration %>%
#   mutate(moved_states = ifelse(!(MIGPLAC1 %in% c(0,27)) & MIGPLAC1<100, 1, 0))
#
# inmigration_by_group_2 <- svydesign(ids = ~1,
#             data= inmigration_by_group_2,
#             weights = inmigration$PERWT)
#
# inmigration_by_group_2 <- svyby(~moved_states, ~geogroup+agegroup, inmigration_by_group_2, svytotal)
######################################
######### Migration from MN ##########
######################################
if (file.exists("outmigration.rda")) {
load("outmigration.rda")
} else {
source("clean.R")
}
outmigration_by_group <- outmigration %>%
as_survey_design(weights=PERWT)  %>%
group_by(geogroup, agegroup) %>%
summarise(moved_out = survey_total())
# #Verify that the srvyr match up with the R survey package
# outmigration_by_group_2 <- outmigration %>% mutate(one = 1)
#
# outmigration_by_group_2 <- svydesign(ids = ~1,
#                                   data= outmigration_by_group_2,
#                                   weights = outmigration_by_group_2$PERWT)
#
# outmigration_by_group_2 <- svyby(~one, ~agegroup+geogroup, outmigration_by_group_2, svytotal)
######################################
######### Graph Net Migration ########
######################################
netmig <- left_join(inmigration_by_group, outmigration_by_group) %>%
mutate(net_migration = moved_in-moved_out )
write.csv(netmig, "netmigration.csv")
netmig_long <- left_join(inmigration_by_group, outmigration_by_group) %>%
gather(direction, mig, moved_in, moved_out) %>%
mutate(se = ifelse(direction=="moved_in", moved_in_se, moved_out_se)) %>%
select(-moved_in_se, -moved_out_se) %>%
mutate(geogroup = factor(geogroup, levels=c("Hennepin","Ramsey", "All Other Counties")),
direction = factor(direction, levels=c("moved_out", "moved_in")))
library(ggplot2)
barplot17_totals <- filter(netmig_long, agegroup=="17 to 23") %>%
ggplot(aes(x=geogroup, y=mig, fill=direction)) +
geom_bar(stat="identity", position="dodge") +
geom_text(aes(x=geogroup, y=mig, label=scales::comma(mig)),
position=position_dodge(width=0.9), vjust=-0.25) +
theme(
panel.background = element_blank(),
axis.ticks.x=element_blank(),
axis.ticks.y=element_blank(),
axis.title.x=element_blank(),
axis.title.y=element_blank(),
axis.text.x=element_text(size=10, color="black"),
axis.text.y=element_blank(),
legend.title=element_blank(),
legend.position="bottom",
plot.caption=element_text(size=8, hjust=.5),
plot.title = element_text(hjust = 0.5)
) +
scale_y_continuous(labels=scales::comma) +
scale_fill_discrete(labels=c("Left MN for Another State", "Moved to MN from Another State")) +
labs(title = "Average Annual Migration between Minnesota and Other States, 2011-2015\nPersons Aged 17 to 23",
caption = "Source: House Research. 2015 American Community Survey 5-year Estimates. IPUMS-USA, University of Minnesota.")
ggsave("ages17to23_totals.png", barplot17_totals,width=8,height=6)
barplot17_errorbars <- filter(netmig_long, agegroup=="17 to 23") %>%
ggplot(aes(x=geogroup, y=mig, fill=direction)) +
geom_bar(stat="identity", position="dodge") +
geom_errorbar(aes(ymin=mig-se, ymax=mig+se),
width = .2,
position=position_dodge(.9)) +
theme(
panel.background = element_blank(),
axis.ticks.x=element_blank(),
axis.ticks.y=element_blank(),
axis.title.x=element_blank(),
axis.title.y=element_blank(),
axis.text.x=element_text(size=10, color="black"),
axis.text.y=element_blank(),
legend.title=element_blank(),
legend.position="bottom",
plot.caption=element_text(size=8, hjust=.5),
plot.title = element_text(hjust = 0.5)
) +
scale_fill_discrete(labels=c("Left MN for Another State", "Moved to MN from Another State")) +
labs(title = "Average Annual Migration between Minnesota and Other States, 2011-2015\nPersons Aged 17 to 23",
caption = "Source: House Research. 2015 American Community Survey 5-year Estimates. IPUMS-USA, University of Minnesota.")
ggsave("ages17to23_errorbars.png", barplot17_errorbars,width=8,height=6)
barplot24 <- filter(netmig_long, agegroup=="24 to 30") %>%
ggplot(aes(x=geogroup, y=mig, fill=direction)) +
geom_bar(stat="identity", position="dodge") +
geom_text(aes(x=geogroup, y=mig, label=scales::comma(mig)),
position=position_dodge(width=0.9), vjust=-0.25) +
theme(
panel.background = element_blank(),
axis.ticks.x=element_blank(),
axis.ticks.y=element_blank(),
axis.title.x=element_blank(),
axis.title.y=element_blank(),
axis.text.x=element_text(size=10, color="black"),
axis.text.y=element_blank(),
legend.title=element_blank(),
legend.position="bottom",
plot.caption=element_text(size=8, hjust=.5),
plot.title = element_text(hjust = 0.5)
) +
scale_fill_discrete(labels=c("Left MN for Another State", "Moved to MN from Another State")) +
labs(title = "Average Annual Migration between Minnesota and Other States, 2011-2015\nPersons Aged 24 to 30",
caption = "Source: House Research. 2015 American Community Survey 5-year Estimates. IPUMS-USA, University of Minnesota.")
ggsave("ages24to30_totals.png", barplot24,width=8,height=6)
barplot24_errorbars <- filter(netmig_long, agegroup=="24 to 30") %>%
ggplot(aes(x=geogroup, y=mig, fill=direction)) +
geom_bar(stat="identity", position="dodge") +
geom_errorbar(aes(ymin=mig-se, ymax=mig+se),
width = .2,
position=position_dodge(.9))+
theme(
panel.background = element_blank(),
axis.ticks.x=element_blank(),
axis.ticks.y=element_blank(),
axis.title.x=element_blank(),
axis.title.y=element_blank(),
axis.text.x=element_text(size=10, color="black"),
axis.text.y=element_blank(),
legend.title=element_blank(),
legend.position="bottom",
plot.caption=element_text(size=8, hjust=.5),
plot.title = element_text(hjust = 0.5)
) +
scale_y_continuous(labels=scales::comma) +
scale_fill_discrete(labels=c("Left MN for Another State", "Moved to MN from Another State")) +
labs(title = "Average Annual Migration between Minnesota and Other States, 2011-2015\nPersons Aged 24 to 30",
caption = "Source: House Research. 2015 American Community Survey 5-year Estimates. IPUMS-USA, University of Minnesota.")
ggsave("ages24to30_errorbars.png", barplot24_errorbars,width=8,height=6)
netmig_long
netmig_long <- left_join(inmigration_by_group, outmigration_by_group)
netmig_long
netmig_long <- left_join(inmigration_by_group, outmigration_by_group) %>%
gather(direction, mig, moved_in, moved_out) %>%
mutate(se = ifelse(direction=="moved_in", moved_in_se, moved_out_se)) %>%
select(-moved_in_se, -moved_out_se) %>%
mutate(geogroup = factor(geogroup, levels=c("Greater MN Counties","Hennepin","Other Metro Counties","Ramsey")),
direction = factor(direction, levels=c("moved_out", "moved_in")))
netmig_long
netmig
netmig_long <- left_join(inmigration_by_group, outmigration_by_group) %>%
mutate(geogroup = ifelse(geogroup=="Greater MN", "Greater Minnesota", geogroup),
geogroup = ifelse(geogroup=="Metro", "Other Metro Counties", geogroup)) %>%
gather(direction, mig, moved_in, moved_out) %>%
mutate(se = ifelse(direction=="moved_in", moved_in_se, moved_out_se)) %>%
select(-moved_in_se, -moved_out_se) %>%
mutate(geogroup = factor(geogroup, levels=c("Ramsey","Hennepin","Other Metro Counties","Greater Minnesota")),
direction = factor(direction, levels=c("moved_out", "moved_in")))
netmig_long
library(ggplot2)
barplot17_totals <- filter(netmig_long, agegroup=="17 to 23") %>%
ggplot(aes(x=geogroup, y=mig, fill=direction)) +
geom_bar(stat="identity", position="dodge") +
geom_text(aes(x=geogroup, y=mig, label=scales::comma(mig)),
position=position_dodge(width=0.9), vjust=-0.25) +
theme(
panel.background = element_blank(),
axis.ticks.x=element_blank(),
axis.ticks.y=element_blank(),
axis.title.x=element_blank(),
axis.title.y=element_blank(),
axis.text.x=element_text(size=10, color="black"),
axis.text.y=element_blank(),
legend.title=element_blank(),
legend.position="bottom",
plot.caption=element_text(size=8, hjust=.5),
plot.title = element_text(hjust = 0.5)
) +
scale_y_continuous(labels=scales::comma) +
scale_fill_discrete(labels=c("Left MN for Another State", "Moved to MN from Another State")) +
labs(title = "Average Annual Migration between Minnesota and Other States, 2011-2015\nPersons Aged 17 to 23",
caption = "Source: House Research. 2015 American Community Survey 5-year Estimates. IPUMS-USA, University of Minnesota.")
ggsave("ages17to23_totals.png", barplot17_totals,width=8,height=6)
barplot17_errorbars <- filter(netmig_long, agegroup=="17 to 23") %>%
ggplot(aes(x=geogroup, y=mig, fill=direction)) +
geom_bar(stat="identity", position="dodge") +
geom_errorbar(aes(ymin=mig-se, ymax=mig+se),
width = .2,
position=position_dodge(.9)) +
theme(
panel.background = element_blank(),
axis.ticks.x=element_blank(),
axis.ticks.y=element_blank(),
axis.title.x=element_blank(),
axis.title.y=element_blank(),
axis.text.x=element_text(size=10, color="black"),
axis.text.y=element_blank(),
legend.title=element_blank(),
legend.position="bottom",
plot.caption=element_text(size=8, hjust=.5),
plot.title = element_text(hjust = 0.5)
) +
scale_fill_discrete(labels=c("Left MN for Another State", "Moved to MN from Another State")) +
labs(title = "Average Annual Migration between Minnesota and Other States, 2011-2015\nPersons Aged 17 to 23",
caption = "Source: House Research. 2015 American Community Survey 5-year Estimates. IPUMS-USA, University of Minnesota.")
ggsave("ages17to23_errorbars.png", barplot17_errorbars,width=8,height=6)
barplot24 <- filter(netmig_long, agegroup=="24 to 30") %>%
ggplot(aes(x=geogroup, y=mig, fill=direction)) +
geom_bar(stat="identity", position="dodge") +
geom_text(aes(x=geogroup, y=mig, label=scales::comma(mig)),
position=position_dodge(width=0.9), vjust=-0.25) +
theme(
panel.background = element_blank(),
axis.ticks.x=element_blank(),
axis.ticks.y=element_blank(),
axis.title.x=element_blank(),
axis.title.y=element_blank(),
axis.text.x=element_text(size=10, color="black"),
axis.text.y=element_blank(),
legend.title=element_blank(),
legend.position="bottom",
plot.caption=element_text(size=8, hjust=.5),
plot.title = element_text(hjust = 0.5)
) +
scale_fill_discrete(labels=c("Left MN for Another State", "Moved to MN from Another State")) +
labs(title = "Average Annual Migration between Minnesota and Other States, 2011-2015\nPersons Aged 24 to 30",
caption = "Source: House Research. 2015 American Community Survey 5-year Estimates. IPUMS-USA, University of Minnesota.")
ggsave("ages24to30_totals.png", barplot24,width=8,height=6)
barplot24_errorbars <- filter(netmig_long, agegroup=="24 to 30") %>%
ggplot(aes(x=geogroup, y=mig, fill=direction)) +
geom_bar(stat="identity", position="dodge") +
geom_errorbar(aes(ymin=mig-se, ymax=mig+se),
width = .2,
position=position_dodge(.9))+
theme(
panel.background = element_blank(),
axis.ticks.x=element_blank(),
axis.ticks.y=element_blank(),
axis.title.x=element_blank(),
axis.title.y=element_blank(),
axis.text.x=element_text(size=10, color="black"),
axis.text.y=element_blank(),
legend.title=element_blank(),
legend.position="bottom",
plot.caption=element_text(size=8, hjust=.5),
plot.title = element_text(hjust = 0.5)
) +
scale_y_continuous(labels=scales::comma) +
scale_fill_discrete(labels=c("Left MN for Another State", "Moved to MN from Another State")) +
labs(title = "Average Annual Migration between Minnesota and Other States, 2011-2015\nPersons Aged 24 to 30",
caption = "Source: House Research. 2015 American Community Survey 5-year Estimates. IPUMS-USA, University of Minnesota.")
ggsave("ages24to30_errorbars.png", barplot24_errorbars,width=8,height=6)
