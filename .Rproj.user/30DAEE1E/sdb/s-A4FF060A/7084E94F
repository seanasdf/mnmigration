{
    "collab_server" : "",
    "contents" : "library(dplyr)\nlibrary(readr)\nlibrary(purrr)\nlibrary(srvyr)\n\n######################################\n######### Migration to MN ############\n######################################\n\n#using srvyr\ninmigration <- read_csv(\"usa_00010.csv.gz\") %>%\n      mutate(geogroup =ifelse(PUMARES2MIG==14, \"Hennepin\", \n                              ifelse(PUMARES2MIG==13, \"Ramsey\", \"All Other Counties\")),\n             agegroup = ifelse(AGE<17, \"16 and Younger\",\n                               ifelse(AGE>=17 & AGE<24, \"17 to 23\",\n                                      ifelse(AGE>=24 & AGE<31, \"24 to 30\", \"31 and Over\")\n                                      )\n                               ),\n             moved = ifelse(!(MIGPLAC1 %in% c(0,27) & MIGPLAC1<100), 1, 0) \n             ) %>%\n      as_survey_design(weights=PERWT) %>%\n      group_by(geogroup, agegroup) %>%\n      summarise(moved_in = survey_total(moved))\n\n\n#Verify that the srvyr match up with the R survey package\nlibrary(survey)\nalternate_inmigration <- read_csv(\"usa_00010.csv.gz\") %>%\n  mutate(geogroup =ifelse(PUMARES2MIG==14, \"Hennepin\", \n                          ifelse(PUMARES2MIG==13, \"Ramsey\", \"All Other Counties\")),\n         agegroup = ifelse(AGE<17, \"16 and Younger\",\n                           ifelse(AGE>=17 & AGE<24, \"17 to 23\",\n                                  ifelse(AGE>=24 & AGE<31, \"24 to 30\", \"31 and Over\")\n                                  )\n                           ),\n         moved = ifelse(!(MIGPLAC1 %in% c(0,27) & MIGPLAC1<100), 1, 0)\n)\n\nalternate_in_survey <- svydesign(ids = ~1,\n                              data= alternate_inmigration,\n                              weights = alternate_inmigration$PERWT)\n\n\nalternate_in_survey <- svyby(~moved, ~geogroup+agegroup, alternate_in_survey, svytotal)\n\n\n######################################\n######### Migration from MN ##########\n######################################\n\noutmigration <- read_csv(\"usa_00009.csv.gz\") %>%\n      filter(STATEFIP != 27) %>%\n      mutate(geogroup =ifelse(MIGPUMA1==1400, \"Hennepin\", \n                              ifelse(MIGPUMA1==1300, \"Ramsey\", \"All Other Counties\")),\n             agegroup = ifelse(AGE<17, \"16 and Younger\",\n                               ifelse(AGE>=17 & AGE<24, \"17 to 23\",\n                                      ifelse(AGE>=24 & AGE<31, \"24 to 30\", \"31 and Over\")\n                               )\n             )) %>%\n      as_survey_design(weights=PERWT)  %>%\n      group_by(geogroup, agegroup) %>%\n      summarise(moved_out = survey_total())\n\n\n#Verify that the srvyr match up with the R survey package\nalternate_outmigration <- read_csv(\"usa_00009.csv.gz\") %>%\n      filter(STATEFIP != 27) %>%\n      mutate(geogroup =ifelse(MIGPUMA1==1400, \"Hennepin\", \n                              ifelse(MIGPUMA1==1300, \"Ramsey\", \"All Other Counties\")),\n             agegroup = ifelse(AGE<17, \"16 and Younger\",\n                               ifelse(AGE>=17 & AGE<24, \"17 to 23\",\n                                      ifelse(AGE>=24 & AGE<31, \"24 to 30\", \"31 and Over\")\n                               )\n             ),\n             one=1) \n\nalternate_out_survey <- svydesign(ids = ~1,\n                                 data= alternate_outmigration,\n                                 weights = alternate_outmigration$PERWT)\n\nalternate_out_survey <- svyby(~one, ~geogroup+agegroup, alternate_out_survey, svytotal)\n\n######################################\n######### Graph Net Migration ########\n######################################\nnetmig <- left_join(inmigration, outmigration) %>%\n      mutate(net_migration = moved_in-moved_out )\nwrite.csv(netmig, \"netmigration.csv\")\n\nlibrary(tidyr)\nnetmig_long <- left_join(inmigration, outmigration) %>%\n      gather(direction, mig, moved_in, moved_out) %>%\n      mutate(se = ifelse(direction==\"moved_in\", moved_in_se, moved_out_se)) %>%\n      select(-moved_in_se, -moved_out_se) %>%\n      mutate(geogroup = factor(geogroup, levels=c(\"Hennepin\",\"Ramsey\", \"All Other Counties\")),\n             direction = factor(direction, levels=c(\"moved_out\", \"moved_in\")))\n\n\nlibrary(ggplot2)\nbarplot17_totals <- filter(netmig_long, agegroup==\"17 to 23\") %>%\n      ggplot(aes(x=geogroup, y=mig, fill=direction)) +\n      geom_bar(stat=\"identity\", position=\"dodge\") +\n      geom_text(aes(x=geogroup, y=mig, label=scales::comma(mig)),\n                position=position_dodge(width=0.9), vjust=-0.25) +\n      theme(\n            panel.background = element_blank(),\n            axis.ticks.x=element_blank(),\n            axis.ticks.y=element_blank(),\n            axis.title.x=element_blank(),\n            axis.title.y=element_blank(),\n            axis.text.x=element_text(size=10, color=\"black\"),\n            axis.text.y=element_blank(),\n            legend.title=element_blank(),\n            legend.position=\"bottom\",\n            plot.caption=element_text(size=8, hjust=.5),\n            plot.title = element_text(hjust = 0.5)\n      ) +\n      scale_y_continuous(labels=scales::comma) +\n      scale_fill_discrete(labels=c(\"Left MN for Another State\", \"Moved to MN from Another State\")) +\n      labs(title = \"Average Annual Migration between Minnesota and Other States, 2011-2015\\nPersons Aged 17 to 23\",\n           caption = \"Source: House Research. 2015 American Community Survey 5-year Estimates. IPUMS-USA, University of Minnesota.\") \n\nggsave(\"ages17to23_totals.png\", barplot17_totals,width=8,height=6) \n\nbarplot17_errorbars <- filter(netmig_long, agegroup==\"17 to 23\") %>%\n  ggplot(aes(x=geogroup, y=mig, fill=direction)) +\n  geom_bar(stat=\"identity\", position=\"dodge\") +\n  geom_errorbar(aes(ymin=mig-se, ymax=mig+se), \n                width = .2,\n                position=position_dodge(.9)) +\n  theme(\n    panel.background = element_blank(),\n    axis.ticks.x=element_blank(),\n    axis.ticks.y=element_blank(),\n    axis.title.x=element_blank(),\n    axis.title.y=element_blank(),\n    axis.text.x=element_text(size=10, color=\"black\"),\n    axis.text.y=element_blank(),\n    legend.title=element_blank(),\n    legend.position=\"bottom\",\n    plot.caption=element_text(size=8, hjust=.5),\n    plot.title = element_text(hjust = 0.5)\n  ) +\n  scale_fill_discrete(labels=c(\"Left MN for Another State\", \"Moved to MN from Another State\")) +\n  labs(title = \"Average Annual Migration between Minnesota and Other States, 2011-2015\\nPersons Aged 17 to 23\",\n       caption = \"Source: House Research. 2015 American Community Survey 5-year Estimates. IPUMS-USA, University of Minnesota.\") \n\nggsave(\"ages17to23_errorbars.png\", barplot17_errorbars,width=8,height=6) \n\n\nbarplot24 <- filter(netmig_long, agegroup==\"24 to 30\") %>%\n      ggplot(aes(x=geogroup, y=mig, fill=direction)) +\n      geom_bar(stat=\"identity\", position=\"dodge\") +\n      geom_text(aes(x=geogroup, y=mig, label=scales::comma(mig)),\n                position=position_dodge(width=0.9), vjust=-0.25) +\n      theme(\n            panel.background = element_blank(),\n            axis.ticks.x=element_blank(),\n            axis.ticks.y=element_blank(),\n            axis.title.x=element_blank(),\n            axis.title.y=element_blank(),\n            axis.text.x=element_text(size=10, color=\"black\"),\n            axis.text.y=element_blank(),\n            legend.title=element_blank(),\n            legend.position=\"bottom\",\n            plot.caption=element_text(size=8, hjust=.5),\n            plot.title = element_text(hjust = 0.5)\n      ) +\n      scale_fill_discrete(labels=c(\"Left MN for Another State\", \"Moved to MN from Another State\")) +\n      labs(title = \"Average Annual Migration between Minnesota and Other States, 2011-2015\\nPersons Aged 24 to 30\",\n           caption = \"Source: House Research. 2015 American Community Survey 5-year Estimates. IPUMS-USA, University of Minnesota.\") \n\nggsave(\"ages24to30_totals.png\", barplot24,width=8,height=6)\n\nbarplot24_errorbars <- filter(netmig_long, agegroup==\"24 to 30\") %>%\n  ggplot(aes(x=geogroup, y=mig, fill=direction)) +\n  geom_bar(stat=\"identity\", position=\"dodge\") +\n  geom_errorbar(aes(ymin=mig-se, ymax=mig+se), \n                width = .2,\n                position=position_dodge(.9))+\n  theme(\n    panel.background = element_blank(),\n    axis.ticks.x=element_blank(),\n    axis.ticks.y=element_blank(),\n    axis.title.x=element_blank(),\n    axis.title.y=element_blank(),\n    axis.text.x=element_text(size=10, color=\"black\"),\n    axis.text.y=element_blank(),\n    legend.title=element_blank(),\n    legend.position=\"bottom\",\n    plot.caption=element_text(size=8, hjust=.5),\n    plot.title = element_text(hjust = 0.5)\n  ) +\n  scale_y_continuous(labels=scales::comma) +\n  scale_fill_discrete(labels=c(\"Left MN for Another State\", \"Moved to MN from Another State\")) +\n  labs(title = \"Average Annual Migration between Minnesota and Other States, 2011-2015\\nPersons Aged 24 to 30\",\n       caption = \"Source: House Research. 2015 American Community Survey 5-year Estimates. IPUMS-USA, University of Minnesota.\") \n\n\nggsave(\"ages24to30_errorbars.png\", barplot24_errorbars,width=8,height=6)\n",
    "created" : 1498595488480.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "4163936180",
    "id" : "7084E94F",
    "lastKnownWriteTime" : 1498598438,
    "last_content_update" : 1498598440515,
    "path" : "I:/User/Williams/Data Assistance/mnmigration/migrationramseyhennepin.R",
    "project_path" : "migrationramseyhennepin.R",
    "properties" : {
    },
    "relative_order" : 1,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}